# Documentation for `impact_vector_so6_with_entry_time.py`

## 1. Overview

This script processes flight trajectory data from an SO6 format CSV file to determine the precise occupancy of predefined 4D traffic volumes. For each flight, it calculates which traffic volumes it passes through, along with the exact entry and exit times for each crossing. The result is a detailed JSON object for each flight, containing a list of "occupancy intervals," flight metadata (origin, destination, takeoff time), and total trajectory distance.

The script is designed for efficiency, utilizing multiprocessing to parallelize the computation across multiple CPU cores. It also creates and uses a `TVTWIndexer`, a persistent mapping of (Traffic Volume, Time Window) pairs to integers, which standardizes the output and is reusable across different runs.

## 2. Key Concepts

- **Traffic Volume (TV):** A 3D geometric shape (a polygon with a minimum and maximum flight level) representing a specific region of airspace. These are defined in a GeoJSON file.
- **Time-Windowed Traffic Volume (TVTW):** A 4D volume representing a Traffic Volume during a specific time interval (e.g., 08:00-08:15). The script discretizes each day into fixed-size time bins (e.g., 15 minutes).
- **TVTW Index:** A unique integer identifier assigned to each TVTW. This is generated by the `TVTWIndexer`.
- **Occupancy Interval:** A dictionary representing a single, continuous period of a flight's presence within one TVTW. It includes the `tvtw_index`, and the flight's `entry_time_s` and `exit_time_s` (measured in seconds from takeoff).
- **Occupancy Data:** The final output for a single flight. It's a JSON object containing a list of that flight's occupancy intervals, its total calculated distance, takeoff time, origin, and destination.

## 3. Workflow

The script follows these steps to generate the occupancy data:

1.  **Load Inputs:** It loads the traffic volumes from the specified GeoJSON file into a GeoDataFrame and the flight data from the SO6 CSV file into a pandas DataFrame.
2.  **Build or Load Indexer:** It checks for a pre-existing `TVTWIndexer` JSON file.
    -   If found, it loads the indexer to ensure consistency with previous runs.
    -   If not found, it builds a new indexer by reading all `traffic_volume_id`s from the GeoJSON file and creating time windows for a 24-hour period based on the `time_bin_minutes` parameter. The new indexer is then saved to disk.
3.  **Group Flights:** The SO6 data, which contains multiple rows (segments) per flight, is grouped by the `flight_identifier`.
4.  **Process Flights in Parallel:** The list of flights is distributed among a pool of worker processes. Each worker executes the `compute_occupancy_for_flight` function on a single flight.
5.  **Compute Occupancy for a Single Flight:** For each flight:
    -   The flight's trajectory is reconstructed by sampling points along its segments (e.g., every 5 nautical miles) and sorting all points chronologically. The flight's takeoff time is recorded.
    -   The script iterates through the time-sorted trajectory points, tracking the set of TVTWs the flight currently occupies.
    -   When the flight moves from a location outside a TVTW to one inside it, a new "occupancy" is opened, and the entry time is recorded.
    -   When the flight moves from being inside a TVTW to outside it, the occupancy is closed. An **Occupancy Interval** is created containing the `tvtw_index`, the recorded `entry_time_s`, and the current `exit_time_s`. All times are relative to the flight's takeoff time.
    -   This process of tracking entry and exit events ensures that each continuous crossing of a TVTW is captured as a distinct interval.
    -   The final result for the flight is a collection of all its occupancy intervals, along with metadata like total distance, takeoff time, origin, and destination.
6.  **Aggregate and Save Results:** The main process collects the detailed occupancy data from all workers. The results are stored in a single dictionary and written to the specified output JSON file.

## 4. Inputs

### SO6 CSV File (`--so6_path`)

A CSV file containing flight trajectory data, where each row represents a segment of a flight.

-   **Required Columns:**
    -   `flight_identifier`: Unique ID for the flight.
    -   `date_begin_segment`, `time_begin_segment`: Start date and time of the segment.
    -   `date_end_segment`, `time_end_segment`: End date and time of the segment.
    -   `longitude_begin`, `latitude_begin`: Geographic coordinates of the segment's start point.
    -   `longitude_end`, `latitude_end`: Geographic coordinates of the segment's end point.
    -   `flight_level_begin`, `flight_level_end`: Flight level (in hundreds of feet) at the start and end of the segment.
    -   `origin_aerodrome`: The flight's origin airport code.
    -   `destination_aerodrome`: The flight's destination airport code.

### Traffic Volumes GeoJSON File (`--tv_path`)

A GeoJSON file where each feature is a `Polygon` representing a 3D traffic volume.

-   **Required Feature Properties:**
    -   `traffic_volume_id` (string): A unique identifier for the traffic volume.
    -   `min_fl` (number): The minimum flight level of the volume.
    -   `max_fl` (number): The maximum flight level of the volume.

## 5. Outputs

### Occupancy Data JSON File (`--output_path`)

A JSON file containing the final computed occupancy data for all processed flights.

-   **Format:** A dictionary where keys are flight identifiers (as strings). Each value is an object containing the flight's metadata and a list of its occupancy intervals.

-   **Example:**
    ```json
    {
        "FLIGHT123": {
            "occupancy_intervals": [
                {
                    "tvtw_index": 101,
                    "entry_time_s": 120.5,
                    "exit_time_s": 350.2
                },
                {
                    "tvtw_index": 250,
                    "entry_time_s": 350.2,
                    "exit_time_s": 680.0
                }
            ],
            "distance": 150.7,
            "takeoff_time": "2023-08-01T08:05:00",
            "origin": "JFK",
            "destination": "BOS"
        },
        "FLIGHT456": {
            ...
        }
    }
    ```

### TVTW Indexer JSON File (`--tvtw_indexer_path`)

A JSON file that stores the `TVTWIndexer` object. This file contains the mapping from (traffic volume ID, time window index) to the final integer index used in the occupancy intervals. It is generated automatically if it doesn't exist.

## 6. Usage

The script is run from the command line. You must provide paths to the input files and specify an output path.

### Command-Line Arguments

-   `--so6_path`: (Required) Path to the SO6 flight data CSV file.
-   `--tv_path`: (Required) Path to the traffic volumes GeoJSON file.
-   `--output_path`: (Required) Path to save the output JSON file with occupancy data.
-   `--tvtw_indexer_path`: (Optional) Path to save or load the TVTW indexer. Defaults to a path next to the output file.
-   `--n_jobs`: (Optional) Number of parallel jobs to run. Defaults to the total number of CPU cores available.
-   `--time_bin_minutes`: (Optional) The duration in minutes for each time window. Defaults to 15.

### Example Command

```bash
python src/project_tailwind/impact_eval/impact_vector_so6_with_entry_time.py \
  --so6_path "D:/project-cirrus/cases/flights_20230801.csv" \
  --tv_path "D:/project-cirrus/cases/traffic_volumes_simplified.geojson" \
  --output_path "output/so6_occupancy_matrix_with_times.json" \
  --time_bin_minutes 15 \
  --n_jobs 8
```
