# Documentation for `impact_vector_so6.py`

## 1. Overview

This script processes flight trajectory data from an SO6 format CSV file to determine the occupancy of predefined 4D traffic volumes. For each flight, it calculates which traffic volumes it passes through and during which time intervals. The result is an "occupancy matrix," a mapping of each flight identifier to a sorted list of unique indices, where each index represents a specific traffic volume in a specific time window.

The script is designed for efficiency, utilizing multiprocessing to parallelize the computation across multiple CPU cores. It also creates and uses a `TVTWIndexer`, a persistent mapping of (Traffic Volume, Time Window) pairs to integers, which standardizes the output and is reusable across different runs.

## 2. Key Concepts

- **Traffic Volume (TV):** A 3D geometric shape (a polygon with a minimum and maximum flight level) representing a specific region of airspace. These are defined in a GeoJSON file.
- **Time-Windowed Traffic Volume (TVTW):** A 4D volume representing a Traffic Volume during a specific time interval (e.g., 08:00-08:15). The script discretizes each day into fixed-size time bins (e.g., 15 minutes).
- **TVTW Index:** A unique integer identifier assigned to each TVTW. This is generated by the `TVTWIndexer`.
- **Occupancy Vector:** A sorted list of TVTW indices for a single flight. This vector represents the complete 4D path of the flight through the defined traffic volumes.
- **Occupancy Matrix:** The final output of the script. It's a JSON object where keys are flight identifiers and values are their corresponding occupancy vectors.

## 3. Workflow

The script follows these steps to generate the occupancy matrix:

1.  **Load Inputs:** It loads the traffic volumes from the specified GeoJSON file into a GeoDataFrame and the flight data from the SO6 CSV file into a pandas DataFrame.
2.  **Build or Load Indexer:** It checks for a pre-existing `TVTWIndexer` JSON file.
    -   If found, it loads the indexer to ensure consistency with previous runs.
    -   If not found, it builds a new indexer by reading all `traffic_volume_id`s from the GeoJSON file and creating time windows for a 24-hour period based on the `time_bin_minutes` parameter. The new indexer is then saved to disk.
3.  **Group Flights:** The SO6 data, which contains multiple rows (segments) per flight, is grouped by the `flight_identifier`.
4.  **Process Flights in Parallel:** The list of flights is distributed among a pool of worker processes. Each worker executes the `compute_occupancy_for_flight` function on a single flight.
5.  **Compute Occupancy for a Single Flight:** For each flight:
    -   An empty set is created to store the unique TVTW indices for that flight.
    -   The flight's segments are processed chronologically.
    -   For each segment (a line from a start point to an end point):
        a.  The script checks which TV(s) the segment's start point falls into, both horizontally (polygon intersection) and vertically (flight level range).
        b.  For each matched TV, it calculates the time window index based on the segment's start time and retrieves the corresponding TVTW index from the indexer. This index is added to the flight's occupancy set.
        c.  To ensure full coverage, the script interpolates and samples points along the trajectory segment (e.g., every 5 nautical miles).
        d.  At each sample point, it repeats the process: find the containing TV(s), calculate the time window, get the TVTW index, and add it to the set.
    -   The final set of indices is converted to a sorted list, which is the flight's occupancy vector.
6.  **Aggregate and Save Results:** The main process collects the occupancy vectors from all workers. The results are stored in a dictionary (the occupancy matrix) and written to the specified output JSON file.

## 4. Inputs

### SO6 CSV File (`--so6_path`)

A CSV file containing flight trajectory data, where each row represents a segment of a flight.

-   **Required Columns:**
    -   `flight_identifier`: Unique ID for the flight.
    -   `date_begin_segment`, `time_begin_segment`: Start date and time of the segment.
    -   `date_end_segment`, `time_end_segment`: End date and time of the segment.
    -   `longitude_begin`, `latitude_begin`: Geographic coordinates of the segment's start point.
    -   `longitude_end`, `latitude_end`: Geographic coordinates of the segment's end point.
    -   `flight_level_begin`, `flight_level_end`: Flight level (in hundreds of feet) at the start and end of the segment.

### Traffic Volumes GeoJSON File (`--tv_path`)

A GeoJSON file where each feature is a `Polygon` representing a 3D traffic volume.

-   **Required Feature Properties:**
    -   `traffic_volume_id` (string): A unique identifier for the traffic volume.
    -   `min_fl` (number): The minimum flight level of the volume.
    -   `max_fl` (number): The maximum flight level of the volume.

## 5. Outputs

### Occupancy Matrix JSON File (`--output_path`)

A JSON file containing the final computed occupancy matrix.

-   **Format:** A dictionary where keys are flight identifiers (as strings) and values are the corresponding occupancy vectors (sorted lists of integers).

-   **Example:**
    ```json
    {
        "FLIGHT123": [101, 102, 250, 251, 252],
        "FLIGHT456": [300, 301, 302, 410, 411],
        ...
    }
    ```

### TVTW Indexer JSON File (`--tvtw_indexer_path`)

A JSON file that stores the `TVTWIndexer` object. This file contains the mapping from (traffic volume ID, time window index) to the final integer index used in the occupancy vectors. It is generated automatically if it doesn't exist.

## 6. Usage

The script is run from the command line. You must provide paths to the input files and specify an output path.

### Command-Line Arguments

-   `--so6_path`: (Required) Path to the SO6 flight data CSV file.
-   `--tv_path`: (Required) Path to the traffic volumes GeoJSON file.
-   `--output_path`: (Required) Path to save the output JSON file with occupancy vectors.
-   `--tvtw_indexer_path`: (Optional) Path to save or load the TVTW indexer. Defaults to a path next to the output file.
-   `--n_jobs`: (Optional) Number of parallel jobs to run. Defaults to the total number of CPU cores available.
-   `--time_bin_minutes`: (Optional) The duration in minutes for each time window. Defaults to 15.

### Example Command

```bash
python src/project_tailwind/impact_eval/impact_vector_so6.py \
  --so6_path "D:/project-cirrus/cases/flights_20230801.csv" \
  --tv_path "D:/project-cirrus/cases/traffic_volumes_simplified.geojson" \
  --output_path "output/so6_occupancy_matrix.json" \
  --time_bin_minutes 15 \
  --n_jobs 8
```
